<td class="selected">
    <mat-checkbox
            *ngIf="testSession.testId >= 0"
            (change)="check($event)"
            (contextmenu)="invertSelectionTestheftWide()"
            [checked]="checked"
    >
    </mat-checkbox>
</td>

<td class="super-state" (click)="deselect($event)" (contextmenu)="deselectForce($event)">
    <div class="vertical-align-middle" *ngIf="superStateIcons[getSuperState(testSession)] as iconData">
        <mat-icon class="unit-badge {{iconData?.class}}" matTooltip="{{iconData.tooltip}}">
            {{iconData.icon}}
        </mat-icon>
    </div>
</td>

<td class="user" (click)="deselect($event)" (contextmenu)="deselectForce($event)">
    <div class="vertical-align-middle">
        <h1>{{testSession.personLabel}}</h1>
    </div>
</td>

<td class="test" (click)="deselect($event)" (contextmenu)="deselectForce($event)">
    <ng-container *ngIf="(booklet$ | async) as booklet">
        <ng-container *ngIf="isBooklet(booklet); else: noBookletReason">

            <div *ngIf="booklet.units as testlet"
                 class="units-container"
                 [class]="{
                    locked: hasState(testSession.testState, 'status', 'locked'),
                    paused: hasState(testSession.testState, 'CONTROLLER', 'PAUSED'),
                    error: hasState(testSession.testState, 'CONTROLLER', 'ERROR'),
                    pending: !hasState(testSession.testState, 'CONTROLLER')
                 }"
                 [ngSwitch]="displayOptions.view"
                 (mouseleave)="mark()"
                 (click)="deselect($event)"
            >
                <div class="units full" *ngSwitchCase="'full'" >
                    <ng-container *ngTemplateOutlet="testletFull; context: {$implicit: testlet}"></ng-container>
                </div>

                <div class="units medium" *ngSwitchCase="'medium'" >
                    <ng-container *ngTemplateOutlet="bookletMedium; context: {$implicit: testlet}"></ng-container>
                </div>

                <div class="units small" *ngSwitchCase="'small'" >
                    <ng-container *ngTemplateOutlet="bookletSmall; context: {$implicit: testlet}"></ng-container>
                </div>
            </div>
        </ng-container>

        <ng-template #noBookletReason>
            <span *ngIf="booklet.error == 'missing-id'">Kein Testheft zugeordnet</span>
            <span *ngIf="booklet.error == 'missing-file'" class="warning">Kein Zugriff auf Testheft-Datei!</span>
            <span *ngIf="booklet.error == 'xml'" class="warning">Konnte Testheft-Datei nicht lesen!</span>
            <span *ngIf="booklet.error == 'general'" class="warning">Fehler beim Zugriff aus Testheft-Datei!</span>
        </ng-template>
    </ng-container>
</td>


<ng-template #testletFull let-testlet>

    <span *ngIf="testlet.restrictions && testlet.restrictions.codeToEnter as codeToEnter"
          class="unit restriction"
          matTooltip="Freigabewort: {{codeToEnter.code.toUpperCase()}}"
          matTooltipPosition="above"
        >
        <mat-icon>{{testletsClearedCode && (testletsClearedCode.indexOf(testlet.id) > -1) ? 'lock_open' : 'lock'}}</mat-icon>
    </span>

    <ng-container *ngFor="let testletOrUnit of testlet.children; trackBy: trackUnits" [ngSwitch]="getTestletType(testletOrUnit)">

        <span *ngSwitchCase="'unit'"
              [class]="{
                unit: true,
                current: testSession.unitName === testletOrUnit.id,
                selected: (selected?.element?.id === testletOrUnit.id) && checked,
                marked: markedElement?.id === testletOrUnit.id
              }"
              (mouseenter)="mark(testletOrUnit)"
              (click)="select($event, testletOrUnit)"
              matTooltip="{{testletOrUnit.label}}"
              matTooltipPosition="above"
            >{{testletOrUnit.labelShort || "&nbsp;"}}
        </span>

        <span *ngSwitchCase="'testlet'"
              [class]="{
                testlet: true,
                selected: (selected?.element?.id === testletOrUnit.id) && checked,
                marked: markedElement?.id === testletOrUnit.id
              }"
              (mouseenter)="mark(testletOrUnit)"
              (click)="select($event, testletOrUnit)"
              matTooltip="{{testletOrUnit.label}}"
            >
            <ng-container *ngTemplateOutlet="testletFull; context: {$implicit: testletOrUnit}"></ng-container>
        </span>

    </ng-container>

</ng-template>


<ng-template #bookletMedium let-testlet>

    <ng-container *ngIf="featuredUnit$ | async as featuredUnit; else: nonFeaturedTestlet">
        <ng-container *ngTemplateOutlet="testletTemplateMedium; context: {testlet: testlet, featuredUnit: featuredUnit}">
        </ng-container>
    </ng-container>

    <ng-template #nonFeaturedTestlet>
        <ng-container *ngTemplateOutlet="testletTemplateMedium; context: {testlet: testlet, featuredUnit: false}">
        </ng-container>
    </ng-template>
</ng-template>


<ng-template #testletTemplateMedium let-testlet="testlet" let-featuredUnit="featuredUnit">

    <ng-container *ngFor="let testletOrUnit of testlet.children; let i = index; trackBy: trackUnits" [ngSwitch]="getTestletType(testletOrUnit)">

        <span *ngSwitchCase="'unit'"
              [class]="(testSession.unitName === testletOrUnit.id) ? 'unit current': 'unit'"
              matTooltip="{{testletOrUnit.label}}"
              matTooltipPosition="above"
        >·
        </span>

        <span *ngSwitchCase="'testlet'" class="testlet" matTooltip="{{testletOrUnit.label}}">

            <ng-container *ngIf="featuredUnit; else: unFeaturedTestlet">
                <span
                        *ngIf="featuredUnit.ancestor.id === testletOrUnit.id; else: unFeaturedTestlet"
                        [class]="{
                            unit: true,
                            aggregated: true,
                            current: true,
                            selected: (selected?.element?.id === testletOrUnit.id) && checked,
                            marked: markedElement?.id === testletOrUnit.id
                        }"
                        matTooltip="{{featuredUnit.unit.label}}"
                        matTooltipPosition="above"
                        (mouseenter)="mark(testletOrUnit)"
                        (click)="select($event, testletOrUnit)"
                >{{featuredUnit.indexAncestor + 1}} / {{featuredUnit.unitCountAncestor}}
                </span>
            </ng-container>

            <ng-template #unFeaturedTestlet>
                <span
                        [class]="{
                            unit: true,
                            aggregated: true,
                            selected: (selected?.element?.id === testletOrUnit.id) && checked,
                            marked: markedElement?.id === testletOrUnit.id
                        }"
                        (mouseenter)="mark(testletOrUnit)"
                        (click)="select($event, testletOrUnit)"
                >{{testletOrUnit.descendantCount}}</span>
            </ng-template>
        </span>
    </ng-container>
</ng-template>


<ng-template #bookletSmall let-testlet>

    <span
            class="testlet" *ngIf="featuredUnit$ | async as featuredUnit; else: unFeaturedTestlet"
            matTooltip="{{featuredUnit.parent.label}}"
        >
        <span
                class="unit current aggregated"
                matTooltip="{{featuredUnit.unit.label}}"
                matTooltipPosition="above"
            >
            {{featuredUnit.indexGlobal + 1}} / {{featuredUnit.unitCountGlobal}}
        </span>
    </span>

    <ng-template #unFeaturedTestlet>
        <span class="testlet" >
            <span class="unit aggregated">{{testlet.descendantCount}}</span>
        </span>
    </ng-template>
</ng-template>


<td class="group" *ngIf="displayOptions.groupColumn === 'show'" (click)="deselect($event)" (contextmenu)="deselectForce($event)">
    <div class="vertical-align-middle">{{testSession.groupLabel}}</div>
</td>

<td class="booklet" *ngIf="displayOptions.bookletColumn === 'show'" (click)="deselect($event)" (contextmenu)="deselectForce($event)">
    <ng-container *ngIf="(booklet$ | async) as booklet">
        <ng-container *ngIf="isBooklet(booklet); else: noBooklet">
            <div class="vertical-align-middle">{{booklet.metadata.label}}</div>
        </ng-container>
    </ng-container>

    <ng-template #noBooklet>
        <div class="vertical-align-middle">{{testSession.bookletName}}</div>
    </ng-template>
</td>

<ng-container *ngIf="featuredUnit$ | async as unitContext; else: noFeaturedUnit">

    <td class="block" (click)="deselect($event)" (contextmenu)="deselectForce($event)" *ngIf="displayOptions.blockColumn === 'show'">
        <div *ngIf="featuredUnit$ | async as unitContext" class="vertical-align-middle">
            {{
          unitContext.parent.label
          || (unitContext.parentIndexGlobal ? 'Block '+ unitContext.parentIndexGlobal + '/' + unitContext.testletCountGlobal : '')
            }}

            <mat-icon class="unit-badge"
                      *ngIf="testletsTimeleft && (testletsTimeleft[unitContext.parent.id] !== undefined)"
                      matBadge="{{testletsTimeleft[unitContext.parent.id].toString()}}"
                      matBadgeColor="accent"
                      matTooltip="Verbleibende Zeit"
            >schedule
            </mat-icon>
        </div>
    </td>

    <td class="current-unit" (click)="deselect($event)" (contextmenu)="deselectForce($event)" *ngIf="displayOptions.unitColumn === 'show'">
        <div class="vertical-align-middle">

            <h2 matTooltip="{{unitContext.unit.label}}">{{unitContext.unit.labelShort || unitContext.unit.id}}</h2>

            <mat-icon class="unit-badge"
                      *ngIf="hasState(testSession.unitState, 'PRESENTATION_PROGRESS', 'complete')"
                      matTooltip="Vollständig betrachtet / angehört"
            >remove_red_eye
            </mat-icon>

            <mat-icon class="unit-badge"
                      *ngIf="hasState(testSession.unitState, 'RESPONSE_PROGRESS', 'complete')"
                      matTooltip="Fertig beantwortet"
            >done_all
            </mat-icon>
            <mat-icon class="unit-badge"
                      *ngIf="hasState(testSession.unitState, 'CURRENT_PAGE_NR')"
                      matBadge="{{this.stateString(testSession.unitState, ['CURRENT_PAGE_NR', 'PAGES_COUNT'], '/')}}"
                      matBadgeColor="accent"
                      matTooltip="{{this.stateString(testSession.unitState, ['CURRENT_PAGE_ID'])}}"
            >description
            </mat-icon>
        </div>
    </td>
</ng-container>

<ng-template #noFeaturedUnit>
    <td></td>
    <td></td>
</ng-template>
